name: CI/CD - Build, Push, Deploy (debug)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show repository root (debug)
        run: |
          echo "=== pwd ==="
          pwd
          echo "=== root listing ==="
          ls -la
          echo "=== top 3 levels (tree) ==="
          find . -maxdepth 3 -type f -printf "%p\n" | sed -n '1,200p' || true
          echo "=== backend listing ==="
          ls -la backend || true
          echo "=== backend Dockerfile (if present) ==="
          if [ -f backend/Dockerfile ]; then
            echo "---- backend/Dockerfile start ----"
            sed -n '1,200p' backend/Dockerfile || true
            echo "---- backend/Dockerfile end ----"
          else
            echo "backend/Dockerfile NOT FOUND"
          fi
          echo "=== frontend listing ==="
          ls -la frontend || true
          echo "=== frontend Dockerfile (if present) ==="
          if [ -f frontend/Dockerfile ]; then
            echo "---- frontend/Dockerfile start ----"
            sed -n '1,200p' frontend/Dockerfile || true
            echo "---- frontend/Dockerfile end ----"
          else
            echo "frontend/Dockerfile NOT FOUND"
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/crud-backend:latest

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/crud-frontend:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Install SSH client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: SSH Deploy to VM (run deploy.sh)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            set -e
            cd /home/${{ secrets.VM_USER }}/crud-mean-devops-assignment || exit 0
            git pull origin main || true
            sudo ./deploy.sh
